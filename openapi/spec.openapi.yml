openapi: 3.0.0

servers:
  - description: OBADA Staging API
    url: https://dev.api.obada.io
  - description: OBADA Production API
    url: http://api.obada.io

info:
  version: "0.0.1"
  title: OBADA API
  termsOfService: 'https://www.obada.io/terms/'
  contact:
    name: Obada Dev Team
    email: techops@obada.io
    url: 'https://www.obada.io'

tags:
  - name: Obit
  - name: Helper

paths:
  /api/client/obits:
    get:
      summary: Returns a list of client obits
      description: ''
      operationId: getClientObits
      tags:
        - Helper
      responses:
        "200":
          $ref: '#/components/responses/ClientObitsResponse'

  /api/client/obit:
    post:
      summary: Save Client Obit
      description: ''
      operationId: saveClientObit
      tags:
        - Helper
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocalObit'
      responses:
        "200":
          $ref: '#/components/responses/ClientObitResponse'
  /api/client/obit/{obit_did}:
    get:
      summary: Get Client Obit
      description: ''
      operationId: getClientObit
      tags:
        - Helper
      parameters:
        - name: obit_did
          description: Required.
          required: true
          in: path
          schema:
            type: string
            example: "did:obada:81413bc1ad2074a6ae35d1f65f64f1bca2e8a20959f37ef0349a729ddc567d9b"
      responses:
        "200":
          $ref: '#/components/responses/ClientObitResponse'
  /api/server/obit/{obit_did}:
    get:
      summary: Get Obit From Blockchain
      description: Retrieves Obit information from blockchain but does not download it.
      operationId: fetchObitFromChain
      tags:
        - Helper
      parameters:
        - name: obit_did
          description: Required.
          required: true
          in: path
          schema:
            type: string
            example: "did:obada:81413bc1ad2074a6ae35d1f65f64f1bca2e8a20959f37ef0349a729ddc567d9b"
      responses:
        "200":
          $ref: '#/components/responses/BlockChainObitResponse'
  /obit/checksum:
    post:
      summary: Generates the obit checksum.
      description: ''
      operationId: checksum
      tags:
        - Obit
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Obit'
      responses:
        "200":
          $ref: '#/components/responses/RootHashResponse'
        "422":
          $ref: "#components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
  /obit/id:
    post:
      summary: Generate Obit ID
      description: 'Returns the Obit ID for a given device_id, part_number and serial_number input.'
      operationId: generateId
      tags:
        - Obit
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestObitId'
      responses:
        "200":
          $ref: "#/components/responses/ObitIdResponse"
        "422":
          $ref: "#components/responses/UnprocessableEntity"
        "500":
          $ref: "#/components/responses/InternalServerError"
  /obits:
    get:
      tags:
        - Obit
      description: Search obits by given filters.
      operationId: searchObits
      parameters:
        - name: serial_number_hash
          description: Query argument that filters by serial number hash
          in: query
          schema:
            type: string
            example: "fe403a1afe16203f4b8bb3a0e72d3e17567897bc15293e4a87b663e441030aea"
        - name: obit_status
          in: query
          description: Query argument that filters by obit status
          schema:
            type: string
            enum:
              - FUNCTIONAL
              - NON_FUNCTIONAL
              - DISPOSED
              - STOLEN
              - DISABLED_BY_OWNER
        - name: manufacturer
          description: Query argument that filters by manufacturer
          in: query
          schema:
            type: string
            example: "Sony"
        - name: part_number
          description: Query argument that filters by part number
          in: query
          schema:
            type: string
            example: "MWCN2LL/A"
        - name: usn
          in: query
          description: Universal serial number
          schema:
            type: string
            example: "2zEz-xLJR"
        - name: owner_did
          in: query
          description: OBADA owner DID
          schema:
            type: string
            example: "did:obada:owner:123456"
        - name: offset
          in: query
          description: Number of records to skip for pagination.
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: limit
          in: query
          description: Maximum number of records to return.
          schema:
            type: integer
            minimum: 0
            maximum: 100
            default: 0
      responses:
        "200":
          description: List of obits responded by given arguments.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Obit"
    post:
      tags:
        - Obit
      description: Creates a new obit.
      operationId: createObit
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Obit"
      responses:
        "201":
          $ref: "#/components/responses/ObitCreated"
        "422":
          $ref: "#/components/responses/UnprocessableEntity"

  /obits/{obit_did}:
    parameters:
      - name: obit_did
        in: path
        description: The given ObitDID argument
        required: true
        schema:
          type: string
          example: "did:obada:fe096095-e0f0-4918-9607-6567bd5756b5"

    get:
      tags:
        - Obit
      description: Shows the information about single Obit by given ObitDID
      operationId: showObit
      responses:
        "200":
          description: Obit in response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Obit"
        "404":
          $ref: "#/components/responses/NotFound"

    put:
      tags:
        - Obit
      description: Updates Obit by given ObitDID with payload
      operationId: updateObit
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Obit"
      responses:
        "201":
          $ref: "#/components/responses/Created"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags:
        - Obit
      description: Changes Obit status to DISABLED_BY_OWNER
      operationId: removeObit
      responses:
        "200":
          $ref: "#/components/responses/NoContent"
        "404":
          $ref: "#/components/responses/NotFound"

  /obits/{obit_did}/history:
    get:
      tags:
        - Obit
      description: Shows the history of changes by given Obit with ObitDID
      operationId: showObitHistory
      parameters:
        - name: obit_did
          in: path
          description: The given ObitDID argument
          required: true
          schema:
            type: string
            example: "did:obada:fe096095-e0f0-4918-9607-6567bd5756b5"
      responses:
        "200":
          $ref: "#/components/responses/ObitHistoryResponse"
        "404":
          $ref: "#/components/responses/NotFound"

components:
  schemas:
    RequestObitId:
      $ref: "definitions/Obit.yml#/RequestObitId"
    BlockChainObit:
      $ref: "definitions/Obit.yml#/BlockChainObit"
    ClientObit:
      $ref: "definitions/Obit.yml#/ClientObit"
    LocalObit:
      $ref: "definitions/Obit.yml#/LocalObit"
    Obit:
      $ref: "definitions/Obit.yml#/Obit"
    ObitHistory:
      $ref: "definitions/Obit.yml#/ObitHistory"
    ObitDefinition:
      description: New Obit def
      type: object
      properties:
        serial_hash:
          type: string
        usn:
          type: string
        obit_did:
          type: string
        usn_base58:
          type: string
  responses:
    ObitIdResponse:
      description: Obit ID response
      content:
        application/json:
          schema:
            $ref: "definitions/Obit.yml#/ObitId"
    ClientObitsResponse:
      description: Client obits response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: integer
              obits:
                type: array
                description: Get description from Rohi
                items:
                  $ref: '#/components/schemas/Obit'
    ClientObitResponse:
      description: Client obit response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: integer
              obit:
                $ref: '#/components/schemas/ClientObit'
    BlockChainObitResponse:
      description: Blockchain obit response
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: integer
              blockchain_obit:
                $ref: '#/components/schemas/BlockChainObit'

    ChecksumResponse:
      description: Obit checksum response
      content:
        application/json:
          schema:
            $ref: "definitions/Obit.yml#/Checksum"

    ObitHistoryResponse:
      description: Collection of historical changes for given obit
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: array
                items:
                  $ref: "#/components/schemas/ObitHistory"
    ObitCreated:
      description: Collection of historical changes for given obit
      content:
        application/json:
          schema:
            type: object
            properties:
              did:
                type: string
              usn:
                type: string
              hash:
                type: string
    Created:
      description: The request was successful and the resource was created.
    NoContent:
      description: The request was successful and no content was returned.
    InternalServerError:
      description: Internal server error.
      content:
        application/json:
          schema:
            $ref: "Errors.yml#/InternalServerError"
    BadRequest:
      description: The request was malformed.
    NotFound:
      description: The requested resource could not be found.
      content:
        application/json:
          schema:
            $ref: "Errors.yml#/NotFound"
    UnprocessableEntity:
      description: The submitted entity could not be processed.
      content:
        application/json:
          schema:
            $ref: "Errors.yml#/UnprocessableEntity"
